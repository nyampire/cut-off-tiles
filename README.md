# cut-off-tiles

XYZタイル形式で格納された画像データセットの検出・分析ツール。連続した白/黒画素を持つタイルの検出と、欠落タイルの特定を行います。

## 機能概要

- **連続白/黒画素検出**: 画像内に一定以上連続した白色または黒色の画素が含まれるタイルを検出
- **欠落タイル検出**: 隣接するタイルとのパターンから欠落しているタイルを特定
- **並列処理**: マルチプロセスによる高速処理
- **インタラクティブモード**: MacのPreviewで画像を表示し、保持/削除の判断が可能
- **自動削除モード**: 検出された問題のあるタイルを自動削除
- **HTML視覚化**: 欠落タイルの検出結果をテーブル形式で視覚的に表示

## 必要条件

- Python 3.12以上
- 必要ライブラリ:
  - `Pillow`
  - `numpy`
- [uv](https://docs.astral.sh/uv/#installation)

## インストール方法

1. リポジトリをクローン:
   ```bash
   git clone https://github.com/nyampire/cut-off-tiles.git
   cd cut-off-tiles
   ```

2. 必要なライブラリをインストール:
   ```bash
   uv sync
   ```

## 使用方法

### 基本的な構文

```bash
uv run cutofftiles.py [ディレクトリパス] [モード] [オプション]
```

### 1. 連続白/黒画素検出モード

#### 基本的な使用例

```bash
# 閾値100で連続した白/黒画素を検出
uv run cutofftiles.py /path/to/tiles --detect-pixels --threshold 100
```

#### 追加オプション

```bash
# 自動削除モード（検出されたタイルを確認なしで削除）
uv run cutofftiles.py /path/to/tiles --detect-pixels --n

# 並列処理のプロセス数を指定（8プロセス）
uv run cutofftiles.py /path/to/tiles --detect-pixels --processes 8

# 閾値と自動削除と並列処理を組み合わせ
uv run cutofftiles.py /path/to/tiles --detect-pixels --threshold 150 --n --processes 4
```

### 2. 欠落タイル検出モード

#### 基本的な使用例

```bash
# 欠落タイルを検出（デフォルトでz/x/y.png形式）
uv run cutofftiles.py /path/to/tiles --detect-missing
```

#### 追加オプション

```bash
# 特定のズームレベルのみ検査
uv run cutofftiles.py /path/to/tiles --detect-missing --zoom 15

# カスタム命名パターンを指定（例：x_y_z.png形式）
uv run cutofftiles.py /path/to/tiles --detect-missing --pattern "(\d+)_(\d+)_(\d+)\.png"

# 最低隣接タイル数を変更（デフォルト: 6）
uv run cutofftiles.py /path/to/tiles --detect-missing --min-neighbors 7

# 境界パディングを変更（デフォルト: 1）
uv run cutofftiles.py /path/to/tiles --detect-missing --padding 2

# HTML出力ファイル名を指定
uv run cutofftiles.py /path/to/tiles --detect-missing --html custom_visualization.html

# HTML視覚化を無効化
uv run cutofftiles.py /path/to/tiles --detect-missing --no-html
```

### ヘルプを表示

```bash
uv run cutofftiles.py --help
```

## オプション一覧

| オプション | 説明 | デフォルト値 |
|---|---|---|
| `--detect-pixels` | 連続した白/黒画素を検出するモード | - |
| `--detect-missing` | 欠落タイルを検出するモード | - |
| `--threshold` | 連続画素の検知閾値 | 100 |
| `--n` | 連続画素検出時に自動的に画像を削除するモード | False |
| `--processes` | 並列処理に使用するプロセス数 | CPU論理コア数 |
| `--zoom` | 検査する特定のズームレベル | すべてのレベル |
| `--pattern` | タイル名のパターン | `(\d+)/(\d+)/(\d+)\.png$` |
| `--min-neighbors` | 欠落と判断するために必要な最低隣接タイル数 | 6 |
| `--padding` | 境界からのパディングサイズ | 1 |
| `--html` | 欠落タイル視覚化のHTML出力ファイル名 | missing_tiles_visualization.html |
| `--no-html` | HTMLの視覚化出力を無効にする | False |

## 出力ファイル

### 欠落タイル検出モードの出力

**HTML視覚化** (デフォルト: `missing_tiles_visualization.html`)
- 欠落タイルの詳細情報をテーブル形式で表示
- ズームレベルごとに分類
- 各タイルのZ/X/Y座標、隣接タイル数、予想されるファイル名を表示

## ユースケース例

### 例1: 連続白黒画素の自動検出と削除

```bash
uv run cutofftiles.py /path/to/tiles --detect-pixels --threshold 100 --n --processes 8
```

この例では:
- ディレクトリ内のすべてのPNGタイルをスキャン
- 100ピクセル以上の連続した白色または黒色の画素を持つタイルを検出
- 検出されたタイルを自動的に削除
- 8つのプロセスで並列処理を実行

### 例2: ズームレベル18の欠落タイル検出と詳細設定

```bash
uv run cutofftiles.py /path/to/tiles --detect-missing --zoom 18 --min-neighbors 7 --padding 2
```

この例では:
- ズームレベル18のタイルのみを検査
- 7つ以上の隣接タイルがある場所の欠落タイルを検出
- 境界から2タイル分内側を検査範囲とする
- 結果をHTMLで視覚化

## 注意事項

- **自動削除モード**: `--n`オプションを使用すると、確認なしでタイルが削除されます。初回使用時はこのオプションを付けずに実行し、削除前に確認することをお勧めします。
- **MacのPreview**: インタラクティブモードはMacのPreviewアプリを使用するため、Mac環境でのみ完全に機能します。他のプラットフォームでは、自動削除モード(`--n`)を使用してください。
- **大規模なタイルセット**: 非常に大きなタイルセットの場合、`--zoom`オプションで特定のズームレベルのみを処理することでメモリ使用量を削減できます。
- **欠落タイル検出の精度**: `--min-neighbors`オプションを調整することで、誤検知の確率を下げることができます。デフォルト値の6は通常良好な結果を示しますが、タイルセットによってはさらに高い値を設定すると良い場合があります。

## ライセンス

MITライセンス - 詳細はLICENSEファイルを参照してください。

## コントリビューション

プルリクエストは歓迎します。大きな変更を行う場合は、まずissueを作成して変更内容を議論してください。

---

© 2025 nyampire, generated by Claude
